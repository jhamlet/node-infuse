/*globals FileList, CLEAN, Task, task, file, sh */

var infuse      = require("infuse"),
    FS          = require("fs"),
    Path        = require("path"),
    infuse      = require("infuse"),
    examplesDir = "examples"
;

CLEAN.include("examples/*/script.js", "examples/*/script.min.js");

task("examples");

FS.readdirSync(examplesDir).forEach(function (name) {
    var dirName     = Path.join(examplesDir, name),
        outputPath  = Path.join(dirName, "script.js"),
        minifyPath  = Path.join(dirName, "script.min.js"),
        inputPath   = Path.join(dirName, "my-script.js"),
        modulePath  = "./" + Path.join(dirName, "my-defines.js"),
        prereqs     = new FileList(inputPath, modulePath)
    ;
    
    // We dump any infusion paths the input may have, so we can add them to
    // the list of prerequisites for the file task (if they change, rebuild
    // the outputPath)
    prereqs.include(infuse(inputPath, {dumpPaths: true}).split("\n"));
    
    file(outputPath, prereqs, function (t) {
        sh(["infuse", inputPath, outputPath, "-d", modulePath, "-N -F"].join(" "));
    });
    
    file(minifyPath, prereqs, function (t) {
        sh(["infuse", inputPath, minifyPath, "-d", modulePath, "-F"].join(" "));
    });
    
    task("examples", [outputPath, minifyPath]);
    
});

task("default", ["examples"]);
